---
layout: default
---
{% if page.title == '日本語' %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endif %}

<div class="newspaper-category">
    <h1 class="category-title">
        {% if page.title == '日本語' %}
            {{ page.title }} 記事
        {% else %}
            {{ page.title }} Posts
        {% endif %}
    </h1>

    {% if page.title == '日本語' %}
    <div class="wanikani-stats">
        <h2>WaniKani レベル進捗</h2>
        <canvas id="levelProgressionChart"></canvas>

        <h2>WaniKani カテゴリーバケツ分布</h2>
        <canvas id="categoryDistributionChart"></canvas> <!-- New chart for distribution -->

        <!-- New Accuracy Table Section -->
        <h2>WaniKani 正確性</h2>
        <table id="accuracyTable" class="accuracy-table">
            <thead>
                <tr>
                    <th></th>
                    <th>Reading</th>
                    <th>Meaning</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- This will be dynamically populated by JavaScript -->
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="newspaper-columns">
        {% for post in site.categories[page.category] %}
            <article class="newspaper-article">
                <h2 class="article-title"><a href="{{ post.url | relative_url }}">{{ post.title }}</a></h2>
                <p class="post-meta">
                    {% if page.category == 'nihongo' %}
                        {{ post.date | date: "%Y年%m月%d日" }}
                    {% else %}
                        {{ post.date | date: "%B %d, %Y" }}
                    {% endif %}
                </p>
                <div class="article-excerpt">
                    {{ post.excerpt | strip_html | truncate: 100 }}
                </div>
                <a href="{{ post.url | relative_url }}" class="read-more">
                    {% if page.category == 'nihongo' %}
                        続きを読む...
                    {% else %}
                        Read more...
                    {% endif %}
                </a>
            </article>
        {% endfor %}
    </div>
</div>

{% if page.title == '日本語' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, attempting to fetch WaniKani stats...');

    // Check if the fetch function exists
    if (typeof fetch !== 'function') {
        console.error('Fetch function not available');
        return;
    }

    const url = 'https://github-pages-data.s3.amazonaws.com/wanikani_stats.json';
    console.log('Fetching from URL:', url);

    fetch(url)
        .then(response => {
            console.log('Received response:', response);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Data parsed successfully:', data);
            if (!data.data || !Array.isArray(data.data)) {
                throw new Error('Unexpected data structure');
            }
            const levelData = data.data
                .filter(item => item.data.passed_at) // Only include levels that have been passed
                .map(item => ({
                    level: item.data.level,
                    startedAt: new Date(item.data.started_at),
                    passedAt: new Date(item.data.passed_at)
                }))
                .sort((a, b) => a.level - b.level); // Sort by level

            console.log('Processed level data:', levelData);
            const ctx = document.getElementById('levelProgressionChart');
            if (!ctx) {
                throw new Error('Could not find chart canvas element');
            }
            console.log('Chart canvas element found');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: levelData.map(d => `レベル ${d.level}`),
                    datasets: [{
                        label: 'レベル達成日数',
                        data: levelData.map(d => (d.passedAt - d.startedAt) / (1000 * 60 * 60 * 24)),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '日数'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += Math.round(context.parsed.y) + ' 日';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            console.log('Chart created successfully');
        })
        .catch(error => {
            console.error('Error creating WaniKani chart:', error);
            document.getElementById('levelProgressionChart').insertAdjacentHTML('afterend', `<p style="color: red;">エラーが発生しました: ${error.message}</p>`);
        });

    fetch('https://github-pages-data.s3.amazonaws.com/all_review_statistics.json')
        .then(response => response.json())
        .then(data => {
            const buckets = {
                Apprentice: { kanji: 0, vocabulary: 0, radical: 0 },
                Guru: { kanji: 0, vocabulary: 0, radical: 0 },
                Master: { kanji: 0, vocabulary: 0, radical: 0 },
                Enlightened: { kanji: 0, vocabulary: 0, radical: 0 },
                Burned: { kanji: 0, vocabulary: 0, radical: 0 }
            };

            // Classify the data into the buckets
            data.forEach(item => {
                const { meaning_current_streak, reading_current_streak, subject_type } = item.data;
                const lowest_streak = Math.min(meaning_current_streak, reading_current_streak);

                let bucket;
                if (lowest_streak < 5) bucket = 'Apprentice';
                else if (lowest_streak === 5) bucket = 'Guru';
                else if (lowest_streak === 6) bucket = 'Master';
                else if (lowest_streak === 7) bucket = 'Enlightened';
                else bucket = 'Burned';

                buckets[bucket][subject_type]++;
            });

            const ctx2 = document.getElementById('categoryDistributionChart');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Apprentice', 'Guru', 'Master', 'Enlightened', 'Burned'],
                    datasets: [
                        {
                            label: 'Kanji',
                            data: [
                                buckets.Apprentice.kanji,
                                buckets.Guru.kanji,
                                buckets.Master.kanji,
                                buckets.Enlightened.kanji,
                                buckets.Burned.kanji
                            ],
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Vocabulary',
                            data: [
                                buckets.Apprentice.vocabulary,
                                buckets.Guru.vocabulary,
                                buckets.Master.vocabulary,
                                buckets.Enlightened.vocabulary,
                                buckets.Burned.vocabulary
                            ],
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Radical',
                            data: [
                                buckets.Apprentice.radical,
                                buckets.Guru.radical,
                                buckets.Master.radical,
                                buckets.Enlightened.radical,
                                buckets.Burned.radical
                            ],
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '数量'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching WaniKani review stats:', error);
        });

    fetch('https://github-pages-data.s3.amazonaws.com/all_review_statistics.json')
        .then(response => response.json())
        .then(data => {
            // Initialize stats object
            const stats = {
                reading: { total: 0, correct: 0 },
                meaning: { total: 0, correct: 0 },
                radical: { total: 0, correct: 0 },   // 'radical' has no readings, only meaning
                kanji: { total: 0, correct: 0 },
                vocabulary: { total: 0, correct: 0 }
            };

            // Process the data
            data.forEach(item => {
                const type = item.data.subject_type;

                // Update meaning stats
                stats.meaning.total += item.data.meaning_correct + item.data.meaning_incorrect;
                stats.meaning.correct += item.data.meaning_correct;

                // Handle subject-specific stats
                if (stats[type]) {
                    // For radicals, only update meaning stats (no reading stats)
                    stats[type].total += item.data.meaning_correct + item.data.meaning_incorrect;
                    stats[type].correct += item.data.meaning_correct;

                    if (type !== 'radical') {
                        // Update reading stats for kanji and vocabulary
                        stats.reading.total += item.data.reading_correct + item.data.reading_incorrect;
                        stats.reading.correct += item.data.reading_correct;

                        stats[type].total += item.data.reading_correct + item.data.reading_incorrect;
                        stats[type].correct += item.data.reading_correct;
                    }
                } else {
                    console.error(`Unexpected subject type: ${type}`);
                }
            });

            // Helper function to calculate percentage
            const calcPercentage = (correct, total) => (total > 0 ? ((correct / total) * 100).toFixed(2) : 0) + '%';

            // Populate the accuracy table
            const tableBody = document.getElementById('accuracyTable').getElementsByTagName('tbody')[0];

            // Clear existing rows
            tableBody.innerHTML = '';

            // Total reviews row
            const totalRow = tableBody.insertRow();
            totalRow.innerHTML = `<td>Total Reviews</td><td>${stats.reading.total}</td><td>${stats.meaning.total}</td><td>${stats.reading.total + stats.meaning.total}</td>`;

            // Correct reviews row
            const correctRow = tableBody.insertRow();
            correctRow.innerHTML = `<td>Correct</td><td>${stats.reading.correct}</td><td>${stats.meaning.correct}</td><td>${stats.reading.correct + stats.meaning.correct}</td>`;

            // Accuracy row
            const accuracyRow = tableBody.insertRow();
            accuracyRow.innerHTML = `<td>Accuracy</td><td>${calcPercentage(stats.reading.correct, stats.reading.total)}</td><td>${calcPercentage(stats.meaning.correct, stats.meaning.total)}</td><td>${calcPercentage(stats.reading.correct + stats.meaning.correct, stats.reading.total + stats.meaning.total)}</td>`;

            // Radical, Kanji, and Vocabulary rows
            ['radical', 'kanji', 'vocabulary'].forEach(type => {
                const row = tableBody.insertRow();
                const readingAccuracy = type === 'radical' ? '---' : calcPercentage(stats[type].correct, stats[type].total);
                const meaningAccuracy = calcPercentage(stats[type].correct, stats[type].total);
                const totalAccuracy = type === 'radical' ? meaningAccuracy : calcPercentage(stats[type].correct, stats[type].total);

                row.innerHTML = `<td>${type.charAt(0).toUpperCase() + type.slice(1)}</td>
                                 <td>${readingAccuracy}</td>
                                 <td>${meaningAccuracy}</td>
                                 <td>${totalAccuracy}</td>`;
            });
        })
        .catch(error => {
            console.error('Error fetching accuracy stats:', error);
        });
});
</script>
{% endif %}
